<% daily_target = 11 %>

<div class="pomodoro-layout"
     data-controller="pomodoro-timer"
     data-pomodoro-timer-today-count-value="<%= @today_count %>"
     data-pomodoro-timer-today-date-value="<%= @today_date %>"
     data-pomodoro-timer-daily-target-value="<%= daily_target %>"
     data-pomodoro-timer-tag-statistics-value="<%= @tag_statistics.to_json %>"
     data-pomodoro-timer-user-signed-in-value="<%= user_signed_in? %>"
     data-pomodoro-timer-has-task-list-value="<%= user_signed_in? && current_user.google_tasks_list_id.present? %>"
     data-pomodoro-timer-target="container">

  <!-- Sidebar Toggle Button -->
  <button 
    class="sidebar-toggle"
    data-pomodoro-timer-target="sidebarToggle"
    data-action="click->pomodoro-timer#toggleSidebar"
    aria-label="Toggle sidebar"
  >
    <span class="sidebar-toggle-icon" data-pomodoro-timer-target="sidebarToggleIcon">â—€</span>
  </button>

  <!-- Left Column: Combined Sidebar -->
  <aside class="sidebar-column" data-pomodoro-timer-target="sidebar">
    
    <!-- History Section (Collapsible) -->
    <div class="sidebar-section" data-pomodoro-timer-target="historySection">
      <button 
        class="section-header"
        data-action="click->pomodoro-timer#toggleHistorySection"
        aria-expanded="true"
      >
        <span class="section-title">Past 5 Days</span>
        <span class="section-toggle-icon" data-pomodoro-timer-target="historySectionIcon">â–¼</span>
      </button>
      <div class="section-content" data-pomodoro-timer-target="historySectionContent">
        <div class="history-list">
          <% @daily_history.each do |day| %>
            <% progress_percent = [(day[:count].to_f / daily_target * 100), 100].min %>
            <div class="history-item <%= day[:count] == 0 ? 'history-item-empty' : '' %>"
                 style="--progress: <%= progress_percent %>%;">
              <span class="history-date"><%= format_history_date(day[:date]) %></span>
              <div class="progress-pill">
                <div class="progress-pill-fill"></div>
                <span class="progress-pill-text"><%= day[:count] %>/<%= daily_target %></span>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Today's Pomodoros Section (Collapsible) -->
    <div class="sidebar-section" data-pomodoro-timer-target="todayPomodorosSection">
      <button 
        class="section-header"
        data-action="click->pomodoro-timer#toggleTodayPomodorosSection"
        aria-expanded="true"
      >
        <span class="section-title">Today's Pomodoros</span>
        <span class="section-toggle-icon" data-pomodoro-timer-target="todayPomodorosSectionIcon">â–¼</span>
      </button>
      <div class="section-content section-content-scrollable" data-pomodoro-timer-target="todayPomodorosSectionContent">
        <div class="today-pomodoros-list" data-pomodoro-timer-target="todayPomodorosList">
          <% if @today_pomodoros.empty? %>
            <div class="today-pomodoros-empty">
              <p>No pomodoros completed today</p>
            </div>
          <% else %>
            <% @today_pomodoros.each do |pomodoro| %>
              <div class="today-pomodoro-item" data-pomodoro-id="<%= pomodoro.id %>">
                <div class="pomodoro-item-content">
                  <span class="pomodoro-item-time"><%= pomodoro.started_at&.strftime("%H:%M") %></span>
                  <span class="pomodoro-item-title"><%= pomodoro.description.presence || "Untitled" %></span>
                </div>
                <button 
                  class="pomodoro-item-delete" 
                  data-action="click->pomodoro-timer#deletePomodoro"
                  data-pomodoro-id="<%= pomodoro.id %>"
                  aria-label="Delete pomodoro"
                >
                  Ã—
                </button>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Calendar Events Section (Collapsible) -->
    <div class="sidebar-section" data-pomodoro-timer-target="calendarSection">
      <button 
        class="section-header"
        data-action="click->pomodoro-timer#toggleCalendarSection"
        aria-expanded="true"
      >
        <span class="section-title">Today's Calendar</span>
        <span class="section-toggle-icon" data-pomodoro-timer-target="calendarSectionIcon">â–¼</span>
      </button>
      <div class="section-content section-content-scrollable" data-pomodoro-timer-target="calendarSectionContent">
        <div class="calendar-content" data-pomodoro-timer-target="calendarContent">
          <% if user_signed_in? %>
            <div class="calendar-loading" data-pomodoro-timer-target="calendarLoading">
              <span class="loading-spinner"></span>
              <span>Loading events...</span>
            </div>
          <% else %>
            <div class="calendar-empty">
              <p>Connect Google to see today's events</p>
            </div>
          <% end %>
          
          <div class="calendar-list hidden" data-pomodoro-timer-target="calendarList"></div>
          <div class="calendar-error hidden" data-pomodoro-timer-target="calendarError"></div>
        </div>
      </div>
    </div>

    <!-- Tasks Section (Collapsible) -->
    <div class="sidebar-section" data-pomodoro-timer-target="tasksSection">
      <button 
        class="section-header"
        data-action="click->pomodoro-timer#toggleTasksSection"
        aria-expanded="true"
      >
        <span class="section-title">Google Tasks</span>
        <span class="section-toggle-icon" data-pomodoro-timer-target="tasksSectionIcon">â–¼</span>
      </button>
      <div class="section-content section-content-scrollable" data-pomodoro-timer-target="tasksSectionContent">
        <div class="tasks-content" data-pomodoro-timer-target="tasksContent">
          <% if user_signed_in? && current_user.google_tasks_list_id.present? %>
            <div class="tasks-loading" data-pomodoro-timer-target="tasksLoading">
              <span class="loading-spinner"></span>
              <span>Loading tasks...</span>
            </div>
          <% elsif user_signed_in? %>
            <div class="tasks-empty">
              <p>No task list selected.</p>
              <%= link_to "Select a list", lists_tasks_path, class: "tasks-setup-link" %>
            </div>
          <% else %>
            <div class="tasks-empty">
              <%= button_to "/auth/google_oauth2", method: :post, data: { turbo: false }, class: "tasks-connect-btn" do %>
                <span>G</span> Connect Google
              <% end %>
            </div>
          <% end %>
          
          <div class="tasks-list hidden" data-pomodoro-timer-target="tasksList"></div>
          <div class="tasks-error hidden" data-pomodoro-timer-target="tasksError"></div>
        </div>
      </div>
      
      <% if user_signed_in? %>
        <div class="section-footer">
          <%= link_to lists_tasks_path, class: "section-footer-link" do %>
            âš™ Change List
          <% end %>
          <%= button_to logout_path, method: :delete, class: "section-footer-link section-signout-link" do %>
            â†ª Sign Out
          <% end %>
        </div>
      <% end %>
    </div>
  </aside>

  <!-- Main Column: Timer Section -->
  <main class="timer-column">
    <!-- Navigation Bar -->
    <nav class="top-nav">
      <button 
        class="nav-button"
        data-action="click->pomodoro-timer#openTagStats"
        aria-label="View time by tag"
      >
        <span class="nav-button-icon">ðŸ•’</span>
        <span class="nav-button-text">Time</span>
      </button>
    </nav>

    <!-- Active Pomodoro Title (shown when running) -->
    <div class="active-title hidden" data-pomodoro-timer-target="activeTitle"></div>

    <!-- Timer Display -->
    <div class="timer-display" data-pomodoro-timer-target="timer">25:00</div>

    <!-- Status Text -->
    <div class="status-text" data-pomodoro-timer-target="status">Ready to start</div>

    <!-- Today's Count Card -->
    <div class="today-count-wrapper">
      <div class="today-count" data-pomodoro-timer-target="todayProgress">
        <span class="today-count-number">
          <span data-pomodoro-timer-target="count"><%= @today_count %></span> / <%= daily_target %>
        </span>
        <span class="today-count-label">today</span>
        <div class="today-count-progress" data-pomodoro-timer-target="progressBar">
          <% daily_target.times do |i| %>
            <div class="today-count-segment <%= i < @today_count ? 'filled' : '' %>"></div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Form Card -->
    <div class="form-card">
      <!-- Description -->
      <div class="form-group">
        <label for="description">Description</label>
        <input
          type="text"
          id="description"
          placeholder="What are you working on?"
          data-pomodoro-timer-target="description"
        >
      </div>

      <!-- Tags Combobox -->
      <div class="form-group">
        <label for="tag-input">Tag</label>
        <div class="combobox" data-pomodoro-timer-target="combobox">
          <input
            type="text"
            id="tag-input"
            placeholder="Search or add a tag..."
            data-pomodoro-timer-target="tagInput"
            data-action="focus->pomodoro-timer#openTagDropdown input->pomodoro-timer#filterTags keydown->pomodoro-timer#handleTagKeydown"
            autocomplete="off"
          >
          <div class="combobox-dropdown hidden" data-pomodoro-timer-target="tagDropdown">
            <% @available_tags.each do |tag| %>
              <div class="combobox-option" 
                   data-tag="<%= tag %>"
                   data-action="click->pomodoro-timer#selectTag">
                <%= tag %>
              </div>
            <% end %>
            <div class="combobox-add-new hidden" 
                 data-pomodoro-timer-target="addNewOption"
                 data-action="click->pomodoro-timer#addNewTag">
              <span class="combobox-add-icon">+</span>
              <span>Add "<span data-pomodoro-timer-target="addNewText"></span>"</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Button Group -->
    <div class="button-group" data-pomodoro-timer-target="buttonGroup">
      <!-- Start Button -->
      <button
        class="start-button"
        data-pomodoro-timer-target="startButton"
        data-action="click->pomodoro-timer#start"
      >
        Start 
      </button>

      <!-- Stop Button (hidden by default, shown during pomodoro) -->
      <button
        class="stop-button hidden"
        data-pomodoro-timer-target="stopButton"
        data-action="click->pomodoro-timer#stop"
      >
        Stop
      </button>
    </div>
  </main>

  <!-- Time by Tag Modal -->
  <div class="modal-overlay hidden" data-pomodoro-timer-target="tagStatsModal" data-action="click->pomodoro-timer#handleModalClick">
    <div class="modal-content" data-modal-content>
      <div class="modal-header">
        <h2 class="modal-title">Time by Tag</h2>
        <button class="modal-close" data-action="click->pomodoro-timer#closeTagStats" aria-label="Close">Ã—</button>
      </div>
      <div class="modal-body">
        <% if @tag_statistics.empty? %>
          <div class="empty-chart-state">
            <div class="empty-chart-placeholder">
              <svg viewBox="0 0 100 100" class="empty-chart-icon">
                <circle cx="50" cy="50" r="40" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                <path d="M50 10 A40 40 0 0 1 90 50" fill="none" stroke="#d1d5db" stroke-width="8" stroke-linecap="round"/>
              </svg>
            </div>
            <p class="empty-chart-message">Complete your first pomodoro with a tag to start tracking time</p>
          </div>
        <% else %>
          <div class="pie-chart-container" data-pomodoro-timer-target="pieChartContainer">
            <canvas data-pomodoro-timer-target="pieChart" width="300" height="300"></canvas>
          </div>
          <div class="tag-stats-legend" data-pomodoro-timer-target="tagStatsLegend">
            <% total = @tag_statistics.sum { |s| s[:count] } %>
            <% @tag_statistics.each_with_index do |stat, index| %>
              <div class="legend-item">
                <span class="legend-color" data-color-index="<%= index %>"></span>
                <span class="legend-label"><%= stat[:tag] %></span>
                <span class="legend-value"><%= stat[:count] %> (<%= ((stat[:count].to_f / total) * 100).round(1) %>%)</span>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
